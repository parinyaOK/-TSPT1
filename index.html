<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลพื้นฐานเครื่องฉีด TSPT1</title> <!-- Updated Title -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Tahoma', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px; /* Increased max-width */
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex; /* Use flexbox for main layout within container */
            flex-direction: column; /* Stack sections vertically */
            gap: 20px; /* Space between sections */
        }
        header h1 {
            color: #2c3e50;
            text-align: center;
            margin: 0 0 20px 0; /* Adjust margin */
        }
        h2, h3 {
            color: #2c3e50;
            margin-top: 0; /* Remove default h2/h3 top margin */
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

         /* Style for the machine selector dropdown options */
         #machine-selector option {
             font-size: 14px; /* Reduced font size for dropdown items */
         }

        .section {
            background-color: #f9f9f9; /* Light background for sections */
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .machine-selection-area {
             background-color: #ecf0f1; /* Different background for selection */
             padding: 20px;
             border-radius: 8px;
             border: 1px solid #ddd;
        }
         .machine-selection-area > div { /* Style divs within selection area */
             margin-bottom: 15px;
         }
         .machine-selection-area > div:last-child {
             margin-bottom: 0;
         }

        .filter-grid { /* New class for arranging filter dropdowns */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Adjust min width as needed */
            gap: 15px;
            margin-bottom: 15px;
        }

        .param-selectors {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .param-group {
            flex: 1;
            min-width: 250px;
            background-color: #fff; /* White background for param groups */
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd; /* Darker border */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .param-group h3 {
            margin-top: 0;
            font-size: 1.1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px; /* Space after border */
        }
        .param-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer; /* Indicate clickable */
        }
         .param-group label:hover {
             color: #007bff; /* Highlight on hover */
         }
        .param-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1); /* Slightly smaller scale */
            cursor: pointer;
        }
        #data-display-area {
            padding-top: 0; /* Remove top padding as section has it */
            border-top: none; /* Remove top border as section has it */
        }
        .data-card {
            background-color: #e9f7ef;
            border-left-width: 5px;
            border-left-style: solid;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .data-card h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        .data-card p {
            margin: 0;
            font-size: 1em;
        }
        .machine-spec { border-left-color: #3498db; background-color: #eaf4fb; } /* Blue */
        .process-param { border-left-color: #2ecc71; background-color: #e9f7ef; } /* Green */
        .material-data { border-left-color: #f39c12; background-color: #fef5e7; } /* Orange - used for process params that are material-specific */

        .basic-info {
            background-color: #ecf0f1; /* Keep basic info color */
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
             border: 1px dashed #ccc; /* Dashed border */
        }
        .basic-info p {
            margin: 5px 0;
        }

        .summary-area {
             padding-top: 20px; /* Keep top padding */
             border-top: 1px solid #ddd; /* Keep top border */
             /* Inherits section padding and border */
        }

        .summary-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Adjust columns as needed */
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background-color: #fff; /* White background for chart containers */
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd; /* Darker border */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex; /* Use flexbox for centering */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

         .chart-container canvas {
             max-width: 100%; /* Ensure canvas doesn't overflow */
             height: 300px; /* Set a fixed height for consistency */
         }

        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: center;
            color: rgba(0, 0, 0, 0.2); /* Very faded gray color */
            font-size: 0.9em; /* Slightly smaller text */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
             .container {
                max-width: 95%;
                margin: 10px auto;
                padding: 15px;
                gap: 15px; /* Smaller gap on mobile */
            }
             .section {
                 padding: 15px; /* Smaller padding for sections */
             }
             .machine-selection-area {
                 padding: 15px;
             }
            .filter-grid { /* Stack filters vertically on small screens */
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .param-selectors {
                flex-direction: column;
            }
            .param-group {
                 min-width: unset; /* Allow groups to shrink */
            }
            input[type="text"],
            select,
            .param-group label {
                font-size: 15px;
            }
             /* Adjust font size for machine selector options on smaller screens if needed */
             #machine-selector option {
                font-size: 13px;
            }
             .summary-charts {
                grid-template-columns: 1fr; /* Stack charts on smaller screens */
                gap: 15px;
            }
             .chart-container canvas {
                 height: 250px; /* Adjust height for smaller screens */
             }
             .footer {
                 margin-top: 20px;
                 padding-top: 10px;
             }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ข้อมูลพื้นฐานเครื่องฉีด TSPT1</h1> <!-- Updated Title -->
        </header>

        <div class="section machine-selection-area">
            <h2>เลือกเครื่องจักร</h2>
            <div class="filter-grid"> <!-- New filter grid container -->
                <div>
                    <label for="group-filter">กลุ่ม:</label>
                    <select id="group-filter">
                        <option value="">-- เลือกทั้งหมด --</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                 <div>
                    <label for="clampforce-filter">แรงหนีบ (ตัน):</label>
                    <select id="clampforce-filter">
                        <option value="">-- เลือกทั้งหมด --</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                 <div>
                    <label for="maker-filter">ผู้ผลิต:</label>
                    <select id="maker-filter">
                        <option value="">-- เลือกทั้งหมด --</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <!-- Removed Screw Diameter Filter -->
                 <div>
                    <label for="capacity-filter">Capacity (กรัม PS):</label>
                    <select id="capacity-filter">
                        <option value="">-- เลือกทั้งหมด --</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>

             <div> <!-- Text search remains separate -->
                <label for="machine-search">ค้นหาด้วยข้อความ (ID, รุ่น):</label>
                <input type="text" id="machine-search" placeholder="พิมพ์ ID, รุ่น...">
            </div>

            <div> <!-- Main machine selector -->
                <label for="machine-selector">เครื่องจักรที่ตรงกับเงื่อนไข:</label>
                <select id="machine-selector">
                    <option value="">-- กรุณาเลือกเครื่องจักร --</option>
                    <!-- Options will be populated by JS based on filters -->
                </select>
            </div>
        </div>

        <div id="selected-machine-basic-info" class="basic-info" style="display: none;">
            <h3>ข้อมูลพื้นฐานเครื่องจักรที่เลือก</h3>
            <p><strong>ผู้ผลิต:</strong> <span id="info-maker"></span></p>
            <p><strong>รุ่น:</strong> <span id="info-model"></span></p>
            <p><strong>แรงหนีบ:</strong> <span id="info-clampforce"></span> ตัน</p>
        </div>

        <div class="section">
            <h2>เลือกพารามิเตอร์ที่ต้องการแสดงผล (เครื่องจักรที่เลือก):</h2>
            <div class="param-selectors">
                <div class="param-group">
                    <h3>Machine Specifications</h3>
                    <label><input type="checkbox" class="param-checkbox" data-key="clampForce" data-unit="ตัน" data-category="machine-spec"> Clamp Force</label>
                    <label><input type="checkbox" class="param-checkbox" data-key="screwDiameter" data-unit="มม." data-category="machine-spec"> Screw Diameter</label>
                    <label><input type="checkbox" class="param-checkbox" data-key="injectionCapacityPS" data-name="Injection Capacity (PS)" data-unit="กรัม" data-category="machine-spec"> Injection Capacity (Ref. PS)</label>
                    <label><input type="checkbox" class="param-checkbox" data-key="maxInjectionPressure" data-name="Max Injection Pressure" data-unit="kgf/cm²" data-category="machine-spec"> Injection Pressure</label>
                    <label><input type="checkbox" class="param-checkbox" data-key="tiebarDistance" data-name="Mold Size (Tiebar HxV)" data-unit="มม." data-category="machine-spec"> Mold Size (HxV)</label>
                    <label><input type="checkbox" class="param-checkbox" data-key="moldThickness" data-name="Mold Thickness Range" data-unit="มม." data-category="machine-spec"> Mold Thickness Range</label>
                    <label><input type="checkbox" class="param-checkbox" data-key="ejectorStroke" data-unit="มม." data-category="machine-spec"> Ejector Stroke</label>
                    <label><input type="checkbox" class="param-checkbox" data-key="locationRingMm" data-name="Locating Ring" data-unit="มม." data-category="machine-spec"> Locating Ring</label>
                </div>

                <div class="param-group">
                    <h3>Process Parameters</h3>
                    <label><input type="checkbox" class="param-checkbox" data-key="shotWeightPer1mmStroke" data-name="Shot Size 1mm" data-category="process-param" data-is-object="true" data-unit-object="กรัม/มม."> Shot Size 1mm (All Materials)</label>
                    <label><input type="checkbox" class="param-checkbox" data-key="recommendedScrewSpeedRpm" data-name="Recommended Screw Speed" data-category="process-param" data-is-object="true" data-unit-object="รอบ/นาที"> Recommended Screw Speed (All Materials)</label>
                    <label><input type="checkbox" class="param-checkbox" data-key="cushionRecommendation" data-name="Cushion Recommendation" data-unit="มม." data-category="process-param"> Cushion Recommendation</label>
                </div>
            </div>
        </div>

        <div id="data-display-area" class="section">
            <p>กรุณาเลือกเครื่องจักรและพารามิเตอร์ที่ต้องการแสดง</p>
        </div>

        <div class="summary-area section">
             <h2>สรุปข้อมูลเครื่องจักรทั้งหมด</h2>
             <p id="total-machines-summary">จำนวนเครื่องจักรทั้งหมด: --</p>

             <div class="summary-charts">
                 <div class="chart-container">
                     <canvas id="makerChart"></canvas>
                 </div>
                  <div class="chart-container">
                     <canvas id="clampForceChart"></canvas>
                 </div>
                   <div class="chart-container">
                     <canvas id="groupClampForceChart"></canvas>
                 </div>
                  <div class="chart-container">
                     <canvas id="groupChart"></canvas>
                 </div>
             </div>
        </div>

        <footer class="footer">
            chaiyapat.cha
        </footer>

    </div>

    <script>
        const machinesData = {
          "machines": [
            {
              "id": "A1", "maker": "TOSHIBA", "model": "IS 650GT-59A", "clampForce": 650, "locationRingMm": 120,
              "tiebarDistance": {"h": 960, "v": 960}, "moldThickness": {"min": 450, "max": 950}, "ejectorStroke": 200,
              "screwDiameter": 95, "injectionCapacityPS": 2900, "maxInjectionPressure": 1887, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 5.18, "PPTalc20": 6.17, "ABS": 7.66, "Nylon6": 6.73 },
              "recommendedScrewSpeedRpm": { "PP": 151, "PPTalc20": 151, "ABS": 110, "Nylon6": 80 }, "machineWeightKg": null
            },
            {
              "id": "A2", "maker": "TOSHIBA", "model": "IS 850GTW-81A", "clampForce": 850, "locationRingMm": 120,
              "tiebarDistance": {"h": 1265, "v": 1265}, "moldThickness": {"min": 500, "max": 1100}, "ejectorStroke": 200,
              "screwDiameter": 105, "injectionCapacityPS": 3980, "maxInjectionPressure": 1866, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 6.32, "PPTalc20": 7.54, "ABS": 11.22, "Nylon6": 8.23 },
              "recommendedScrewSpeedRpm": { "PP": 124, "PPTalc20": 124, "ABS": 100, "Nylon6": 73 }, "machineWeightKg": null
            },
            {
              "id": "A3", "maker": "JSW", "model": "J 650 EIIW-13A", "clampForce": 650, "locationRingMm": 120,
              "tiebarDistance": {"h": 1085, "v": 1085}, "moldThickness": {"min": 450, "max": 1000}, "ejectorStroke": 180,
              "screwDiameter": 92, "injectionCapacityPS": 2903, "maxInjectionPressure": 1820, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 4.85, "PPTalc20": 5.78, "ABS": 6.87, "Nylon6": 6.87 },
              "recommendedScrewSpeedRpm": { "PP": 156, "PPTalc20": 156, "ABS": 114, "Nylon6": 83 }, "machineWeightKg": null
            },
            {
              "id": "A4", "maker": "MITSUBISHI", "model": "650 MG-110", "clampForce": 650, "locationRingMm": 120,
              "tiebarDistance": {"h": 950, "v": 950}, "moldThickness": {"min": 450, "max": 900}, "ejectorStroke": 200,
              "screwDiameter": 90, "injectionCapacityPS": 2890, "maxInjectionPressure": 1650, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 4.64, "PPTalc20": 5.53, "ABS": 5.66, "Nylon6": 6.05 },
              "recommendedScrewSpeedRpm": { "PP": 159, "PPTalc20": 159, "ABS": 117, "Nylon6": 85 }, "machineWeightKg": null
            },
            {
              "id": "A5", "maker": "TOSHIBA", "model": "IS 650EW-54A", "clampForce": 650, "locationRingMm": 120,
              "tiebarDistance": {"h": 1080, "v": 1080}, "moldThickness": {"min": 450, "max": 900}, "ejectorStroke": 180,
              "screwDiameter": 90, "injectionCapacityPS": 2890, "maxInjectionPressure": 1720, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 4.64, "PPTalc20": 5.53, "ABS": 5.66, "Nylon6": 6.05 },
              "recommendedScrewSpeedRpm": { "PP": 159, "PPTalc20": 159, "ABS": 117, "Nylon6": 85 }, "machineWeightKg": null
            },
            {
              "id": "A6", "maker": "TOSHIBA", "model": "IS 850GTW-81A", "clampForce": 850, "locationRingMm": 120,
              "tiebarDistance": {"h": 1265, "v": 1265}, "moldThickness": {"min": 500, "max": 1100}, "ejectorStroke": 200,
              "screwDiameter": 105, "injectionCapacityPS": 3980, "maxInjectionPressure": 1866, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 6.32, "PPTalc20": 7.54, "ABS": 9.35, "Nylon6": 8.23 },
              "recommendedScrewSpeedRpm": { "PP": 136, "PPTalc20": 136, "ABS": 100, "Nylon6": 73 }, "machineWeightKg": null
            },
            {
              "id": "A9", "maker": "JSW", "model": "J450EII B", "clampForce": 450, "locationRingMm": 120,
              "tiebarDistance": {"h": 810, "v": 810}, "moldThickness": {"min": 280, "max": 650}, "ejectorStroke": 150,
              "screwDiameter": 84, "injectionCapacityPS": 1511, "maxInjectionPressure": 1500, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 4.05, "PPTalc20": 4.82, "ABS": 4.93, "Nylon6": 5.27 },
              "recommendedScrewSpeedRpm": { "PP": 170, "PPTalc20": 170, "ABS": 125, "Nylon6": 91 }, "machineWeightKg": null
            },
            {
              "id": "A10", "maker": "JSW", "model": "J450EII B", "clampForce": 450, "locationRingMm": 120,
              "tiebarDistance": {"h": 810, "v": 810}, "moldThickness": {"min": 280, "max": 650}, "ejectorStroke": 150,
              "screwDiameter": 84, "injectionCapacityPS": 1511, "maxInjectionPressure": 1500, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 4.05, "PPTalc20": 4.82, "ABS": 4.93, "Nylon6": 5.27 },
              "recommendedScrewSpeedRpm": { "PP": 170, "PPTalc20": 170, "ABS": 125, "Nylon6": 91 }, "machineWeightKg": null
            },
            {
              "id": "A11", "maker": "TOSHIBA", "model": "IS 850GTW-81A", "clampForce": 850, "locationRingMm": 120,
              "tiebarDistance": {"h": 1265, "v": 1265}, "moldThickness": {"min": 500, "max": 1100}, "ejectorStroke": 200,
              "screwDiameter": 105, "injectionCapacityPS": 3980, "maxInjectionPressure": 1866, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 6.32, "PPTalc20": 7.54, "ABS": 9.35, "Nylon6": 8.23 },
              "recommendedScrewSpeedRpm": { "PP": 136, "PPTalc20": 136, "ABS": 100, "Nylon6": 73 }, "machineWeightKg": null
            },
            {
              "id": "A12", "maker": "TOSHIBA", "model": "IS1300DGW-110A", "clampForce": 1300, "locationRingMm": 120,
              "tiebarDistance": {"h": 1415, "v": 1415}, "moldThickness": {"min": 700, "max": 1200}, "ejectorStroke": 250,
              "screwDiameter": 115, "injectionCapacityPS": 6040, "maxInjectionPressure": 1700, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 7.58, "PPTalc20": 9.04, "ABS": 11.22, "Nylon6": 8.23 },
              "recommendedScrewSpeedRpm": { "PP": 124, "PPTalc20": 124, "ABS": 91, "Nylon6": 66 }, "machineWeightKg": null
            },
            {
              "id": "A13", "maker": "TOSHIBA", "model": "IS 850GTW-81A", "clampForce": 850, "locationRingMm": 120,
              "tiebarDistance": {"h": 1265, "v": 1265}, "moldThickness": {"min": 500, "max": 1100}, "ejectorStroke": 200,
              "screwDiameter": 105, "injectionCapacityPS": 3980, "maxInjectionPressure": 1866, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 6.32, "PPTalc20": 7.54, "ABS": 9.35, "Nylon6": 8.23 },
              "recommendedScrewSpeedRpm": { "PP": 136, "PPTalc20": 136, "ABS": 100, "Nylon6": 73 }, "machineWeightKg": null
            },
            {
              "id": "A14", "maker": "JSW", "model": "J 1300EWI6AC5", "clampForce": 1300, "locationRingMm": 120,
              "tiebarDistance": {"h": 1400, "v": 1400}, "moldThickness": {"min": 650, "max": 1300}, "ejectorStroke": 250,
              "screwDiameter": 120, "injectionCapacityPS": 5966, "maxInjectionPressure": 1700, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 8.26, "PPTalc20": 9.84, "ABS": 12.21, "Nylon6": 10.74 },
              "recommendedScrewSpeedRpm": { "PP": 119, "PPTalc20": 119, "ABS": 87, "Nylon6": 64 }, "machineWeightKg": null
            },
            {
              "id": "A15", "maker": "TOSHIBA", "model": "IS 850EW-80A", "clampForce": 850, "locationRingMm": 120,
              "tiebarDistance": {"h": 1265, "v": 1265}, "moldThickness": {"min": 420, "max": 1085}, "ejectorStroke": 200,
              "screwDiameter": 100, "injectionCapacityPS": 3970, "maxInjectionPressure": 1840, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 5.73, "PPTalc20": 6.84, "ABS": 8.48, "Nylon6": 7.46 },
              "recommendedScrewSpeedRpm": { "PP": 143, "PPTalc20": 143, "ABS": 105, "Nylon6": 76 }, "machineWeightKg": null
            },
            {
              "id": "A16", "maker": "TOSHIBA", "model": "IS 850FA3W-81A", "clampForce": 850, "locationRingMm": 120,
              "tiebarDistance": {"h": 1265, "v": 1265}, "moldThickness": {"min": 420, "max": 1085}, "ejectorStroke": 200,
              "screwDiameter": 105, "injectionCapacityPS": 3980, "maxInjectionPressure": 1840, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 6.32, "PPTalc20": 7.54, "ABS": 9.35, "Nylon6": 8.23 },
              "recommendedScrewSpeedRpm": { "PP": 136, "PPTalc20": 136, "ABS": 100, "Nylon6": 73 }, "machineWeightKg": null
            },
            {
              "id": "A17", "maker": "TOSHIBA", "model": "IS 850GTW-81A", "clampForce": 850, "locationRingMm": 120,
              "tiebarDistance": {"h": 1265, "v": 1265}, "moldThickness": {"min": 500, "max": 1100}, "ejectorStroke": 200,
              "screwDiameter": 105, "injectionCapacityPS": 3980, "maxInjectionPressure": 1866, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 6.32, "PPTalc20": 7.54, "ABS": 9.35, "Nylon6": 8.23 },
              "recommendedScrewSpeedRpm": { "PP": 136, "PPTalc20": 136, "ABS": 100, "Nylon6": 73 }, "machineWeightKg": null
            },
            {
              "id": "A18", "maker": "TOSHIBA", "model": "IS 850GTW-81A", "clampForce": 850, "locationRingMm": 120,
              "tiebarDistance": {"h": 1265, "v": 1265}, "moldThickness": {"min": 500, "max": 1100}, "ejectorStroke": 200,
              "screwDiameter": 105, "injectionCapacityPS": 3980, "maxInjectionPressure": 1866, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 6.32, "PPTalc20": 7.54, "ABS": 9.35, "Nylon6": 8.23 },
              "recommendedScrewSpeedRpm": { "PP": 136, "PPTalc20": 136, "ABS": 100, "Nylon6": 73 }, "machineWeightKg": null
            },
            {
              "id": "A19", "maker": "JSW", "model": "J 1300EWI6AC5", "clampForce": 1300, "locationRingMm": 120,
              "tiebarDistance": {"h": 1400, "v": 1400}, "moldThickness": {"min": 650, "max": 1300}, "ejectorStroke": 250,
              "screwDiameter": 120, "injectionCapacityPS": 5966, "maxInjectionPressure": 1700, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 8.26, "PPTalc20": 9.84, "ABS": 12.21, "Nylon6": 10.74 },
              "recommendedScrewSpeedRpm": { "PP": 119, "PPTalc20": 119, "ABS": 87, "Nylon6": 64 }, "machineWeightKg": null
            },
            {
              "id": "A20", "maker": "TOSHIBA", "model": "IS1600DFW-150A", "clampForce": 1600, "locationRingMm": 120,
              "tiebarDistance": {"h": 1800, "v": 1500}, "moldThickness": {"min": 800, "max": 1500}, "ejectorStroke": 250,
              "screwDiameter": 125, "injectionCapacityPS": 7750, "maxInjectionPressure": 1750, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 8.96, "PPTalc20": 10.67, "ABS": 12.21, "Nylon6": 11.66 },
              "recommendedScrewSpeedRpm": { "PP": 115, "PPTalc20": 115, "ABS": 84, "Nylon6": 61 }, "machineWeightKg": null
            },
            {
              "id": "B4", "maker": "TOSHIBA", "model": "IS 150EN-5A", "clampForce": 150, "locationRingMm": 100,
              "tiebarDistance": {"h": 510, "v": 510}, "moldThickness": {"min": 190, "max": 425}, "ejectorStroke": 100,
              "screwDiameter": 40, "injectionCapacityPS": 230, "maxInjectionPressure": 2000, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 0.92, "PPTalc20": 1.09, "ABS": 1.12, "Nylon6": 1.19 },
              "recommendedScrewSpeedRpm": { "PP": 358, "PPTalc20": 358, "ABS": 262, "Nylon6": 191 }, "machineWeightKg": null
            },
            {
              "id": "B5", "maker": "TOSHIBA", "model": "IS170G-5A", "clampForce": 170, "locationRingMm": 100,
              "tiebarDistance": {"h": 510, "v": 510}, "moldThickness": {"min": 190, "max": 425}, "ejectorStroke": 100,
              "screwDiameter": 40, "injectionCapacityPS": 230, "maxInjectionPressure": 2000, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 0.92, "PPTalc20": 1.09, "ABS": 1.12, "Nylon6": 1.19 },
              "recommendedScrewSpeedRpm": { "PP": 358, "PPTalc20": 358, "ABS": 262, "Nylon6": 191 }, "machineWeightKg": null
            },
            {
              "id": "B6", "maker": "TOSHIBA", "model": "IS 170FA-5A", "clampForce": 170, "locationRingMm": 100,
              "tiebarDistance": {"h": 510, "v": 510}, "moldThickness": {"min": 190, "max": 425}, "ejectorStroke": 100,
              "screwDiameter": 40, "injectionCapacityPS": 230, "maxInjectionPressure": 2000, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 0.92, "PPTalc20": 1.09, "ABS": 1.12, "Nylon6": 1.19 },
              "recommendedScrewSpeedRpm": { "PP": 358, "PPTalc20": 358, "ABS": 262, "Nylon6": 191 }, "machineWeightKg": null
            },
            {
              "id": "B10", "maker": "AP", "model": "SM350", "clampForce": 350, "locationRingMm": 120,
              "tiebarDistance": {"h": 700, "v": 700}, "moldThickness": {"min": 260, "max": 700}, "ejectorStroke": 150,
              "screwDiameter": 75, "injectionCapacityPS": 1045, "maxInjectionPressure": 1470, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 3.23, "PPTalc20": 3.84, "ABS": 3.93, "Nylon6": 4.20 },
              "recommendedScrewSpeedRpm": { "PP": 191, "PPTalc20": 191, "ABS": 140, "Nylon6": 102 }, "machineWeightKg": null
            },
            {
              "id": "B11", "maker": "TOSHIBA", "model": "IS 350FA3-27A", "clampForce": 350, "locationRingMm": 100,
              "tiebarDistance": {"h": 710, "v": 710}, "moldThickness": {"min": 300, "max": 625}, "ejectorStroke": 125,
              "screwDiameter": 70, "injectionCapacityPS": 1360, "maxInjectionPressure": 1820, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 2.81, "PPTalc20": 3.35, "ABS": 3.43, "Nylon6": 3.66 },
              "recommendedScrewSpeedRpm": { "PP": 204, "PPTalc20": 204, "ABS": 150, "Nylon6": 109 }, "machineWeightKg": null
            },
            {
              "id": "B12", "maker": "TOSHIBA", "model": "IS 350GS-27A", "clampForce": 350, "locationRingMm": 100,
              "tiebarDistance": {"h": 730, "v": 730}, "moldThickness": {"min": 300, "max": 625}, "ejectorStroke": 125,
              "screwDiameter": 70, "injectionCapacityPS": 1360, "maxInjectionPressure": 1815, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 2.81, "PPTalc20": 3.35, "ABS": 3.43, "Nylon6": 3.66 },
              "recommendedScrewSpeedRpm": { "PP": 204, "PPTalc20": 204, "ABS": 150, "Nylon6": 109 }, "machineWeightKg": null
            },
            {
              "id": "B13", "maker": "AP", "model": "SM350", "clampForce": 350, "locationRingMm": 120,
              "tiebarDistance": {"h": 700, "v": 700}, "moldThickness": {"min": 260, "max": 700}, "ejectorStroke": 150,
              "screwDiameter": 75, "injectionCapacityPS": 1045, "maxInjectionPressure": 1470, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 3.23, "PPTalc20": 3.84, "ABS": 3.93, "Nylon6": 4.20 },
              "recommendedScrewSpeedRpm": { "PP": 191, "PPTalc20": 191, "ABS": 140, "Nylon6": 102 }, "machineWeightKg": null
            },
            {
              "id": "B15", "maker": "JSW", "model": "J 1300EIIW", "clampForce": 1300, "locationRingMm": 120,
              "tiebarDistance": {"h": 1400, "v": 1400}, "moldThickness": {"min": 650, "max": 1300}, "ejectorStroke": 250,
              "screwDiameter": 120, "injectionCapacityPS": 5966, "maxInjectionPressure": 1700, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 8.26, "PPTalc20": 9.84, "ABS": 12.21, "Nylon6": 10.74 },
              "recommendedScrewSpeedRpm": { "PP": 119, "PPTalc20": 119, "ABS": 87, "Nylon6": 64 }, "machineWeightKg": null
            },
            {
              "id": "B18", "maker": "AP", "model": "SM350", "clampForce": 350, "locationRingMm": 120,
              "tiebarDistance": {"h": 700, "v": 700}, "moldThickness": {"min": 260, "max": 700}, "ejectorStroke": 150,
              "screwDiameter": 75, "injectionCapacityPS": 1045, "maxInjectionPressure": 1470, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 3.23, "PPTalc20": 3.84, "ABS": 3.93, "Nylon6": 4.20 },
              "recommendedScrewSpeedRpm": { "PP": 191, "PPTalc20": 191, "ABS": 140, "Nylon6": 102 }, "machineWeightKg": null
            },
            {
              "id": "D1", "maker": "MITSUBISHI", "model": "1300MMVW-240", "clampForce": 1300, "locationRingMm": 120,
              "tiebarDistance": {"h": 1400, "v": 1400}, "moldThickness": {"min": 700, "max": 1200}, "ejectorStroke": 250,
              "screwDiameter": 120, "injectionCapacityPS": 6240, "maxInjectionPressure": 1640, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 8.26, "PPTalc20": 9.84, "ABS": 12.21, "Nylon6": 10.74 },
              "recommendedScrewSpeedRpm": { "PP": 119, "PPTalc20": 119, "ABS": 87, "Nylon6": 64 }, "machineWeightKg": null
            },
            {
              "id": "D2", "maker": "TOSHIBA", "model": "IS 850GTW-81A", "clampForce": 850, "locationRingMm": 120,
              "tiebarDistance": {"h": 1265, "v": 1265}, "moldThickness": {"min": 500, "max": 1100}, "ejectorStroke": 200,
              "screwDiameter": 105, "injectionCapacityPS": 3980, "maxInjectionPressure": 1866, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 6.32, "PPTalc20": 7.54, "ABS": 9.35, "Nylon6": 8.23 },
              "recommendedScrewSpeedRpm": { "PP": 136, "PPTalc20": 136, "ABS": 100, "Nylon6": 73 }, "machineWeightKg": null
            },
            {
              "id": "D3", "maker": "MITSUBISHI", "model": "650 ME2-110", "clampForce": 650, "locationRingMm": 120,
              "tiebarDistance": {"h": 960, "v": 960}, "moldThickness": {"min": 400, "max": 1000}, "ejectorStroke": 200,
              "screwDiameter": 90, "injectionCapacityPS": 2630, "maxInjectionPressure": 1805, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 4.64, "PPTalc20": 5.53, "ABS": 5.66, "Nylon6": 6.05 },
              "recommendedScrewSpeedRpm": { "PP": 159, "PPTalc20": 159, "ABS": 117, "Nylon6": 85 }, "machineWeightKg": null
            },
            {
              "id": "D4", "maker": "AP", "model": "SM450", "clampForce": 450, "locationRingMm": 120,
              "tiebarDistance": {"h": 780, "v": 780}, "moldThickness": {"min": 300, "max": 800}, "ejectorStroke": 180,
              "screwDiameter": 75, "injectionCapacityPS": 1264, "maxInjectionPressure": 1840, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 3.23, "PPTalc20": 3.84, "ABS": 3.93, "Nylon6": 4.20 },
              "recommendedScrewSpeedRpm": { "PP": 191, "PPTalc20": 191, "ABS": 140, "Nylon6": 102 }, "machineWeightKg": null
            },
            {
              "id": "D6", "maker": "TOSHIBA", "model": "IS 650GT-59A", "clampForce": 650, "locationRingMm": 120,
              "tiebarDistance": {"h": 960, "v": 960}, "moldThickness": {"min": 450, "max": 950}, "ejectorStroke": 200,
              "screwDiameter": 95, "injectionCapacityPS": 2900, "maxInjectionPressure": 1887, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 5.18, "PPTalc20": 6.17, "ABS": 7.66, "Nylon6": 6.73 },
              "recommendedScrewSpeedRpm": { "PP": 151, "PPTalc20": 151, "ABS": 110, "Nylon6": 80 }, "machineWeightKg": null
            },
            {
              "id": "D7", "maker": "JSW", "model": "J 650 EIIW-13A", "clampForce": 650, "locationRingMm": 120,
              "tiebarDistance": {"h": 1085, "v": 1085}, "moldThickness": {"min": 450, "max": 1000}, "ejectorStroke": 180,
              "screwDiameter": 92, "injectionCapacityPS": 2903, "maxInjectionPressure": 1820, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 4.85, "PPTalc20": 5.78, "ABS": 6.87, "Nylon6": 6.87 },
              "recommendedScrewSpeedRpm": { "PP": 156, "PPTalc20": 156, "ABS": 114, "Nylon6": 83 }, "machineWeightKg": null
            },
            {
              "id": "D8", "maker": "TOSHIBA", "model": "IS 650GT-59A", "clampForce": 650, "locationRingMm": 120,
              "tiebarDistance": {"h": 1080, "v": 1080}, "moldThickness": {"min": 450, "max": 900}, "ejectorStroke": 180,
              "screwDiameter": 90, "injectionCapacityPS": 2890, "maxInjectionPressure": 1720, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 4.64, "PPTalc20": 5.53, "ABS": 5.66, "Nylon6": 6.05 },
              "recommendedScrewSpeedRpm": { "PP": 159, "PPTalc20": 159, "ABS": 117, "Nylon6": 85 }, "machineWeightKg": null
            },
            {
              "id": "D9", "maker": "TOSHIBA", "model": "IS 850GTW-81A", "clampForce": 850, "locationRingMm": 120,
              "tiebarDistance": {"h": 1265, "v": 1265}, "moldThickness": {"min": 500, "max": 1100}, "ejectorStroke": 200,
              "screwDiameter": 105, "injectionCapacityPS": 3980, "maxInjectionPressure": 1866, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 6.32, "PPTalc20": 7.54, "ABS": 9.35, "Nylon6": 8.23 },
              "recommendedScrewSpeedRpm": { "PP": 136, "PPTalc20": 136, "ABS": 100, "Nylon6": 73 }, "machineWeightKg": null
            },
            {
              "id": "D10", "maker": "AP", "model": "SM350", "clampForce": 350, "locationRingMm": 120,
              "tiebarDistance": {"h": 700, "v": 700}, "moldThickness": {"min": 260, "max": 700}, "ejectorStroke": 150,
              "screwDiameter": 75, "injectionCapacityPS": 1045, "maxInjectionPressure": 1470, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 3.23, "PPTalc20": 3.84, "ABS": 3.93, "Nylon6": 4.20 },
              "recommendedScrewSpeedRpm": { "PP": 191, "PPTalc20": 191, "ABS": 140, "Nylon6": 102 }, "machineWeightKg": null
            },
            {
              "id": "D11", "maker": "AP", "model": "SM350", "clampForce": 350, "locationRingMm": 120,
              "tiebarDistance": {"h": 700, "v": 700}, "moldThickness": {"min": 260, "max": 700}, "ejectorStroke": 150,
              "screwDiameter": 75, "injectionCapacityPS": 1045, "maxInjectionPressure": 1470, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 3.23, "PPTalc20": 3.84, "ABS": 3.93, "Nylon6": 4.20 },
              "recommendedScrewSpeedRpm": { "PP": 191, "PPTalc20": 191, "ABS": 140, "Nylon6": 102 }, "machineWeightKg": null
            },
            {
              "id": "D12", "maker": "U-MHIPT", "model": "3000MMX-470", "clampForce": 3000, "locationRingMm": 200,
              "tiebarDistance": {"h": 2050, "v": 1900}, "moldThickness": {"min": 1000, "max": 1900}, "ejectorStroke": 400,
              "screwDiameter": 150, "injectionCapacityPS": 12100, "maxInjectionPressure": 1800, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 12.90, "PPTalc20": 15.38, "ABS": 19.08, "Nylon6": 16.78 },
              "recommendedScrewSpeedRpm": { "PP": 95, "PPTalc20": 95, "ABS": 70, "Nylon6": 51 }, "machineWeightKg": null
            },
            {
              "id": "D13", "maker": "U-MHIPT", "model": "3000MMX-470", "clampForce": 3000, "locationRingMm": 200,
              "tiebarDistance": {"h": 2050, "v": 1900}, "moldThickness": {"min": 1000, "max": 1900}, "ejectorStroke": 400,
              "screwDiameter": 150, "injectionCapacityPS": 12100, "maxInjectionPressure": 1800, "cushionRecommendation": "3-6",
              "shotWeightPer1mmStroke": { "PP": 12.90, "PPTalc20": 15.38, "ABS": 19.08, "Nylon6": 16.78 },
              "recommendedScrewSpeedRpm": { "PP": 95, "PPTalc20": 95, "ABS": 70, "Nylon6": 51 }, "machineWeightKg": null
            }
          ]
        };

        const machineSearchInput = document.getElementById('machine-search');
        const machineSelector = document.getElementById('machine-selector');
        const dataDisplayArea = document.getElementById('data-display-area');
        const paramCheckboxes = document.querySelectorAll('.param-checkbox');
        const selectedMachineBasicInfoDiv = document.getElementById('selected-machine-basic-info');
        const totalMachinesSummary = document.getElementById('total-machines-summary');

        // New filter selectors
        const groupFilterSelect = document.getElementById('group-filter');
        const clampForceFilterSelect = document.getElementById('clampforce-filter');
        const makerFilterSelect = document.getElementById('maker-filter');
        // Removed screwFilterSelect
        const capacityFilterSelect = document.getElementById('capacity-filter');

        let currentSelectedMachine = null;
        let makerChart = null;
        let clampForceChart = null;
        let groupChart = null;
        let groupClampForceChart = null;

        function populateFilterSelect(selectElement, values, valueKey, sortNumeric = false) { // Removed labelKey argument
            selectElement.innerHTML = '<option value="">-- เลือกทั้งหมด --</option>'; // Reset

            let uniqueValues = [];
             if (valueKey === 'group') {
                 uniqueValues = [...new Set(values.map(item => item.id.charAt(0).toUpperCase()))];
                 uniqueValues.sort(); // Sort groups alphabetically
            } else if (sortNumeric) {
                 // Filter out null/undefined before sorting numeric
                 uniqueValues = [...new Set(values.map(item => item[valueKey]).filter(v => v !== undefined && v !== null))];
                 uniqueValues.sort((a, b) => a - b); // Sort numerically
            } else {
                 uniqueValues = [...new Set(values.map(item => item[valueKey]).filter(v => v !== undefined && v !== null))];
                 uniqueValues.sort(); // Sort alphabetically
            }

            uniqueValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                 let optionText = value;
                if (valueKey === 'clampForce') optionText = `${value} ตัน`;
                if (valueKey === 'screwDiameter') optionText = `${value} มม.`;
                if (valueKey === 'injectionCapacityPS') optionText = `${value} กรัม PS`;
                 if (valueKey === 'group') optionText = `กลุ่ม ${value}`;

                 option.textContent = optionText;
                selectElement.appendChild(option);
            });
        }

        function populateMachineSelector(machinesToPopulate) {
            machineSelector.innerHTML = '<option value="">-- กรุณาเลือกเครื่องจักร --</option>'; // Reset

            // Sort the machinesToPopulate array first by group (A, B, D), then by clamp force (numeric)
            machinesToPopulate.sort((a, b) => {
                const groupA = a.id.charAt(0);
                const groupB = b.id.charAt(0);
                if (groupA !== groupB) {
                    return groupA.localeCompare(groupB); // Sort by group (A, B, D...)
                }
                return a.clampForce - b.clampForce; // Sort by clamp force within the same group
            });

            machinesToPopulate.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = `${machine.id} - ${machine.maker} - ${machine.model} (${machine.clampForce} T)`;
                machineSelector.appendChild(option);
            });
        }

        function displayBasicMachineInfo(machine) {
            if (machine) {
                document.getElementById('info-maker').textContent = machine.maker;
                document.getElementById('info-model').textContent = machine.model;
                document.getElementById('info-clampforce').textContent = machine.clampForce;
                selectedMachineBasicInfoDiv.style.display = 'block';
            } else {
                document.getElementById('info-maker').textContent = '';
                document.getElementById('info-model').textContent = '';
                document.getElementById('info-clampforce').textContent = '';
                selectedMachineBasicInfoDiv.style.display = 'none';
            }
        }

        function renderData() {
            dataDisplayArea.innerHTML = ''; // Clear previous data

            if (!currentSelectedMachine) {
                dataDisplayArea.innerHTML = '<p>กรุณาเลือกเครื่องจักร</p>';
                displayBasicMachineInfo(null);
                return;
            }

            displayBasicMachineInfo(currentSelectedMachine);

            let cardsRendered = 0;
            paramCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const key = checkbox.dataset.key;
                    const displayName = checkbox.dataset.name || checkbox.labels[0].textContent.trim();
                    const unit = checkbox.dataset.unit || '';
                    const category = checkbox.dataset.category || 'process-param';
                    const isObject = checkbox.dataset.isObject === 'true';
                    const unitObject = checkbox.dataset.unitObject || 'กรัม'; // Default for material objects

                    const value = currentSelectedMachine[key];

                    if (value === undefined || value === null) {
                        const card = document.createElement('div');
                        card.className = `data-card ${category}`;
                         card.innerHTML = `
                             <h4>${displayName}</h4>
                             <p>ข้อมูลไม่พร้อมใช้งาน</p>
                         `;
                         dataDisplayArea.appendChild(card);
                         cardsRendered++;
                         return;
                    }

                    if (isObject && typeof value === 'object') {
                        Object.entries(value).sort().forEach(([subKey, subValue]) => {
                            const card = document.createElement('div');
                            card.className = `data-card ${category === 'process-param' ? 'material-data' : category}`;
                            card.innerHTML = `
                                <h4>${displayName} (${subKey})</h4>
                                <p>${subValue !== null ? subValue : 'N/A'} ${unitObject}</p>
                            `;
                            dataDisplayArea.appendChild(card);
                            cardsRendered++;
                        });
                    } else {
                        const card = document.createElement('div');
                        card.className = `data-card ${category}`;
                        let displayValue = value;
                        if (typeof value === 'object') { // For tiebarDistance, moldThickness
                            if (key === 'tiebarDistance') displayValue = `${value.h} x ${value.v}`;
                            else if (key === 'moldThickness') displayValue = `${value.min} - ${value.max}`;
                            else displayValue = JSON.stringify(value); // Fallback for other objects
                        }

                        card.innerHTML = `
                            <h4>${displayName}</h4>
                            <p>${displayValue !== null ? displayValue : 'N/A'} ${unit}</p>
                        `;
                        dataDisplayArea.appendChild(card);
                        cardsRendered++;
                    }
                }
            });

            if (cardsRendered === 0 && currentSelectedMachine) {
                 dataDisplayArea.innerHTML = '<p>กรุณาเลือกพารามิเตอร์ที่ต้องการแสดง</p>';
            }
        }

        function applyFilters() {
            const searchTerm = machineSearchInput.value.toLowerCase();
            const selectedGroup = groupFilterSelect.value;
            const selectedForce = clampForceFilterSelect.value;
            const selectedMaker = makerFilterSelect.value;
            // Removed selectedScrew
            const selectedCapacity = capacityFilterSelect.value;

            const filteredMachines = machinesData.machines.filter(machine => {
                const matchesSearchTerm = machine.id.toLowerCase().includes(searchTerm) ||
                                         machine.model.toLowerCase().includes(searchTerm);

                const matchesGroup = selectedGroup === '' || machine.id.charAt(0).toUpperCase() === selectedGroup;
                // Ensure numeric comparison for clamp force if filter is selected
                const matchesForce = selectedForce === '' || (machine.clampForce !== null && machine.clampForce.toString() === selectedForce);
                const matchesMaker = selectedMaker === '' || machine.maker === selectedMaker;
                // Removed matchesScrew check
                 // Ensure numeric comparison for capacity if filter is selected
                 const matchesCapacity = selectedCapacity === '' || (machine.injectionCapacityPS !== null && machine.injectionCapacityPS.toString() === selectedCapacity);

                return matchesSearchTerm && matchesGroup && matchesForce && matchesMaker && matchesCapacity; // Updated filter logic
            });

            populateMachineSelector(filteredMachines);

            // Check if the currently selected machine is still in the filtered list
            if (currentSelectedMachine && !filteredMachines.find(m => m.id === currentSelectedMachine.id)) {
                machineSelector.value = ""; // Reset dropdown selection visually
                currentSelectedMachine = null;
                renderData(); // Clear data display as selected machine is no longer valid
            } else if (currentSelectedMachine && filteredMachines.find(m => m.id === currentSelectedMachine.id)) {
                 // If the machine *is* still in the list, ensure the selector shows it
                 machineSelector.value = currentSelectedMachine.id;
            } else {
                // If there was no machine selected, or the selected one was removed and nothing is selected,
                // ensure the display area is cleared.
                 renderData();
            }
        }

        function calculateSummary(machines) {
            const totalCount = machines.length;
            const makerCounts = {};
            const clampForceCounts = {};
            const groupCounts = {};
            const groupClampForceCounts = {};

            machines.forEach(machine => {
                const group = machine.id.charAt(0).toUpperCase();
                const force = machine.clampForce;
                const maker = machine.maker;

                // Count by Maker
                makerCounts[maker] = (makerCounts[maker] || 0) + 1;

                // Count by Clamp Force
                if (force !== null && force !== undefined) { // Ensure clampForce exists
                    clampForceCounts[force] = (clampForceCounts[force] || 0) + 1;
                }

                // Count by Group (ID Prefix)
                 if (group) { // Ensure group exists
                    groupCounts[group] = (groupCounts[group] || 0) + 1;
                 }

                // Count by Group + Clamp Force
                if (group && force !== null && force !== undefined) { // Ensure both exist
                    const groupForceKey = `${group}-${force}`;
                    groupClampForceCounts[groupForceKey] = (groupClampForceCounts[groupForceKey] || 0) + 1;
                }

            });

            // Sort counts for consistent chart display
             const sortedMakerCounts = Object.fromEntries(Object.entries(makerCounts).sort());
             const sortedClampForceCounts = Object.fromEntries(Object.entries(clampForceCounts).sort((a, b) => parseInt(a[0]) - parseInt(b[0]))); // Sort numerically
             const sortedGroupCounts = Object.fromEntries(Object.entries(groupCounts).sort()); // Sort alphabetically by group letter
             const sortedGroupClampForceCounts = Object.fromEntries(Object.entries(groupClampForceCounts).sort((a, b) => {
                 const [groupA, forceA] = a[0].split('-');
                 const [groupB, forceB] = b[0].split('-');
                 if (groupA !== groupB) {
                     return groupA.localeCompare(groupB);
                 }
                 return parseInt(forceA) - parseInt(forceB);
             }));

            return {
                totalCount,
                makerCounts: sortedMakerCounts,
                clampForceCounts: sortedClampForceCounts,
                groupCounts: sortedGroupCounts,
                groupForceLabels: Object.keys(sortedGroupClampForceCounts).map(key => { // Format labels for the chart
                     const [group, force] = key.split('-');
                     return `กลุ่ม ${group} - ${force}T`;
                }),
                groupForceData: Object.values(sortedGroupClampForceCounts)
            };
        }

         function renderSummaryCharts(summaryData) {
            // Destroy existing charts if they exist
            if (makerChart) makerChart.destroy();
            if (clampForceChart) clampForceChart.destroy();
            if (groupChart) groupChart.destroy();
            if (groupClampForceChart) groupClampForceChart.destroy();

            // Total Count Display
            totalMachinesSummary.textContent = `จำนวนเครื่องจักรทั้งหมด: ${summaryData.totalCount} เครื่อง`;

            // --- Maker Chart (Bar) ---
            const makerCtx = document.getElementById('makerChart').getContext('2d');
            makerChart = new Chart(makerCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(summaryData.makerCounts),
                    datasets: [{
                        label: 'จำนวนเครื่อง',
                        data: Object.values(summaryData.makerCounts),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                             'rgba(255, 159, 64, 0.7)'
                        ],
                         borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                             'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'จำนวนเครื่องจักรแยกตามผู้ผลิต',
                            font: { size: 16 }
                        },
                         legend: {
                             display: false
                         }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                             ticks: {
                                 stepSize: 1,
                                 callback: function(value) { if (value % 1 === 0) { return value; } }
                             },
                            title: {
                                display: true,
                                text: 'จำนวนเครื่อง'
                            }
                        },
                         x: {
                             title: {
                                 display: true,
                                 text: 'ผู้ผลิต'
                             }
                         }
                    }
                }
            });

            // --- Clamp Force Chart (Bar) ---
             const clampForceCtx = document.getElementById('clampForceChart').getContext('2d');
             clampForceChart = new Chart(clampForceCtx, {
                 type: 'bar',
                 data: {
                     labels: Object.keys(summaryData.clampForceCounts).map(force => `${force} ตัน`),
                     datasets: [{
                         label: 'จำนวนเครื่อง',
                         data: Object.values(summaryData.clampForceCounts),
                         backgroundColor: 'rgba(52, 152, 219, 0.7)',
                         borderColor: 'rgba(52, 152, 219, 1)',
                         borderWidth: 1
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         title: {
                             display: true,
                             text: 'จำนวนเครื่องจักรแยกตามแรงหนีบ',
                              font: { size: 16 }
                         },
                          legend: {
                             display: false
                         }
                     },
                     scales: {
                         y: {
                             beginAtZero: true,
                             ticks: {
                                 stepSize: 1,
                                 callback: function(value) { if (value % 1 === 0) { return value; } }
                             },
                             title: {
                                 display: true,
                                 text: 'จำนวนเครื่อง'
                             }
                         },
                          x: {
                             title: {
                                 display: true,
                                 text: 'แรงหนีบ (ตัน)'
                             }
                         }
                     }
                 }
             });

            // --- Group + Clamp Force Chart (Bar) ---
             const groupClampForceCtx = document.getElementById('groupClampForceChart').getContext('2d');
             groupClampForceChart = new Chart(groupClampForceCtx, {
                 type: 'bar',
                 data: {
                     labels: summaryData.groupForceLabels,
                     datasets: [{
                         label: 'จำนวนเครื่อง',
                         data: summaryData.groupForceData,
                         backgroundColor: summaryData.groupForceLabels.map(label => {
                             if (label.startsWith('กลุ่ม A')) return 'rgba(46, 204, 113, 0.8)';
                             if (label.startsWith('กลุ่ม B')) return 'rgba(155, 89, 182, 0.8)';
                             if (label.startsWith('กลุ่ม D')) return 'rgba(241, 196, 15, 0.8)';
                             return 'rgba(52, 152, 219, 0.7)';
                         }),
                          borderColor: summaryData.groupForceLabels.map(label => {
                             if (label.startsWith('กลุ่ม A')) return 'rgba(39, 174, 96, 1)';
                             if (label.startsWith('กลุ่ม B')) return 'rgba(142, 68, 173, 1)';
                             if (label.startsWith('กลุ่ม D')) return 'rgba(243, 156, 18, 1)';
                             return 'rgba(41, 128, 185, 1)';
                         }),
                         borderWidth: 1
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         title: {
                             display: true,
                             text: 'จำนวนเครื่องจักรแยกตามกลุ่มและแรงหนีบ',
                              font: { size: 16 }
                         },
                          legend: {
                             display: false
                         },
                          tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return `${tooltipItem.label}: ${tooltipItem.raw} เครื่อง`;
                                }
                            }
                        }
                     },
                     scales: {
                         y: {
                             beginAtZero: true,
                             ticks: {
                                 stepSize: 1,
                                 callback: function(value) { if (value % 1 === 0) { return value; } }
                             },
                             title: {
                                 display: true,
                                 text: 'จำนวนเครื่อง'
                             }
                         },
                          x: {
                             title: {
                                 display: true,
                                 text: 'กลุ่ม - แรงหนีบ'
                             }
                         }
                     }
                 }
             });

            // --- Group Chart (Pie Chart) ---
            const groupCtx = document.getElementById('groupChart').getContext('2d');
            groupChart = new Chart(groupCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(summaryData.groupCounts).map(group => `กลุ่ม ${group}`),
                    datasets: [{
                        label: 'จำนวนเครื่อง',
                        data: Object.values(summaryData.groupCounts),
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(155, 89, 182, 0.8)',
                            'rgba(241, 196, 15, 0.8)',
                            'rgba(231, 76, 60, 0.8)'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                     plugins: {
                         title: {
                             display: true,
                             text: 'สัดส่วนเครื่องจักรแยกตามกลุ่ม',
                              font: { size: 16 }
                         },
                          tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    let label = tooltipItem.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += tooltipItem.raw + ' เครื่อง';
                                    const total = tooltipItem.dataset.data.reduce((sum, current) => sum + current, 0);
                                    const percentage = ((tooltipItem.raw / total) * 100).toFixed(1);
                                    label += ` (${percentage}%)`;
                                    return label;
                                }
                            }
                        }
                     }
                }
            });
        }

        // Event Listeners for Filters and Search
        machineSearchInput.addEventListener('input', applyFilters);
        groupFilterSelect.addEventListener('change', applyFilters);
        clampForceFilterSelect.addEventListener('change', applyFilters);
        makerFilterSelect.addEventListener('change', applyFilters);
        // Removed event listener for screwFilterSelect
        capacityFilterSelect.addEventListener('change', applyFilters);

        // Event Listener for main machine selector
        machineSelector.addEventListener('change', (e) => {
            const selectedId = e.target.value;
            currentSelectedMachine = machinesData.machines.find(m => m.id === selectedId) || null;
            renderData(); // Render data for the selected machine (or clear if none selected)
        });

        // Event Listeners for parameter checkboxes
        paramCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', renderData);
        });

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Populate filter dropdowns first based on ALL machines
            populateFilterSelect(groupFilterSelect, machinesData.machines, 'group');
            populateFilterSelect(clampForceFilterSelect, machinesData.machines, 'clampForce', true); // Sort numerically
            populateFilterSelect(makerFilterSelect, machinesData.machines, 'maker');
            // Removed populateFilterSelect for screwDiameter
            populateFilterSelect(capacityFilterSelect, machinesData.machines, 'injectionCapacityPS', true); // Sort numerically

            // Apply filters initially (will show all machines in selector)
            applyFilters();

            // Calculate and render summary charts based on ALL machines
            const summaryData = calculateSummary(machinesData.machines);
            renderSummaryCharts(summaryData);
        });

    </script>
</body>
</html>